# CBC Casper解释

为了帮助更多人理解“另一版本的Casper”（Vlad Zamfir提出的CBC Casper），特别是最适合区块链协议的实例化，我将亲自撰写一份解释，从一个不那么抽象并且更“接近于具体使用”的角度进行阐述。Vlad关于CBC Casper的描述可以参见[这里](https://www.youtube.com/watch?v=GNGbd_RbrzE)和[这里](https://github.com/ethereum/cbc-casper/wiki/FAQ)和[这里](https://github.com/cbc-casper/cbc-casper-paper)。欢迎大家积极探讨这些材料。

CBC Casper的设计基础非常全面且抽象，并且其几乎对任何数据结构都能达成共识——你可以使用CBC Casper来决定选0还是选1；你可以在CBC上运行一个简单的区块链，或者2^92维超立方缠结(tangle)DAG，以及它们之间的几乎任意东西。 

但为了简单起见，我们首先将注意力集中在一个具体的案例上：一个简单的基于链的结构。我们假设有一个由N个验证者组成的固定的验证者集合（即常说的“抵押节点”。我们还假设每个节点都抵押相同数量的币，对于不满足这一假设的情形，我们可以通过给一些节点分配多个验证者ID来进行模拟）。我们把时间分解为长度为10秒的时隙（slot），并且验证者k可以在k，N+1，2N+k等时隙中创建区块。每个区块指向一个特定的母区块。显然，如果我们想要创造一些最简单的东西，我们只能采用这种结构，在它上面实施最长链规则，并称之为1天。

![img](.\img\fig1_longest_chain.png)!

绿色的链是最长的链（长度为6），因此它被认为是“权威链”。

然而，在这里我们的重点是增加一些“最终化”（finality）的概念：即某些区块能够在链上得到及其稳固的确认，稳固到其无法被其他竞争区块所取代，除非有数量极其庞大（比如1/4）的验证者作出某些唯一的可归因的错误行为（比如以某种明显且可被密码学验证为恶意的行为行事）。如果很大一部分验证者确实采取恶意行为来回滚区块，那么这一恶意行为的证据将被提交到链，从而罚没这些验证者的全部保证金。如此一来，回滚最终化的成本将会非常昂贵（想想，白花花的几亿美金）。

## LMD GHOST

这一部分的内容我们不妨徐徐展开。首先，我们替换了分叉选择规则（在众多选项中决定哪条链是“权威链”的规则，即哪条链应为用户所关注）。我们不再选用简单的最长链规则，而是改由“最新消息驱动的GHOST”。为了说明LMD GHOST的工作原理，我们将修改上述例子。为了使其更加具体，我们不妨假设验证者集合的大小为5，并将其中每一位验证者标记为A，B，C，D，E。由此，验证者A在第0个和第5个时隙生成区块，验证者B在第1个和第6个时隙生成区块，依次类推。评估LMD GHOST分叉选择规则的客户端只关注由每一个验证者签署的最新（即最高时隙）消息（即区块）：

![](.\img\fig2_lmd_ghost.png) 

蓝色表示最新的消息，从左到右时隙依次递增（例如，最左端的A的区块位于第0个时隙，依次类推）

现在，我们仅使用这些消息作为“贪婪的最重可观察子树”（GHOST）分叉选择规则的源数据：从创世区块开始，然后每次出现分叉，选择拥有更多最新消息支持的区块的子树的一侧（即更多最新消息支持该区块或者该区块的其中一个后代），并继续执行直到到达没有子代的区块。我们可以为每个区块计算支持其自身或者它其中一个后代的最新消息的子集。

![img](.\img\fig3_lmd_ghost.png) 

现在，要计算头部，我们从创始区块开始，然后在每一个分叉处选择最高的数字：首先，选择底下的链，因为相比起上面这条只有1条最新消息支持的单一区块链，底下的链有4条支持自己的最新消息，然后在下一个分叉处支持中间的链。最终的结果与最长链相同。事实上，在一个运行良好（即孤儿率很低）的网络中，大多数时候LMD GHOST和最长链规则都会给出完全相同的答案。但在更极端的情形中，就不定是这样了。例如，我们不妨考虑下述这条链，其发生了三次区块分叉：

![img](.\img\fig3_score_block_by_length.png) 

按链的长度为区块赋予权重。如果我们遵循最长链规则，那么顶链更长，所以顶链获胜。

![img](.\img\fig4_score_block_length&ghost.png) 

按支持该链的最新消息的数量并使用GHOST规则对区块赋予权重（最新消息来自图中用蓝色标示的验证者）。底下的链当前获得更多验证者的支持。因此，如果我们遵循LMD GHOST规则，那么底下的链将获胜，尽管我们暂不清楚这三个区块谁处于优先状态。

LMD GHOST方法在某些情形中具有过人的优势，它可以更好地在高延迟条件下提取信息。如果两个验证者分别创建出一个共享同一个母代的区块，那么实际上它们可以被认为是对母区块表示共同支持，即使它们同时也在为自己竞争选票。最长链规则无法捕捉到这种细微的差别，而基于GHOST的规则可以。

## 检查终局性（finality）

LMD GHOST方法还有另外一个很棒的特性：它的黏性很大。例如，假设在两轮投票中，4/5的验证者都投票给同一条链（我们假设这5个验证者中的验证者B没有进行投票，此刻B正在进行攻击）：

![img](.\img\fig5_chain.png) 

如果想要成为权威链，最上面的链需要什么？已经有4个验证者基于E的第一个区块来构建新的区块，并且这4个验证者都识别出了E在LMD分叉选择中拥有最高的权重。

仅仅通过查看这条链的结构，我们就可以直到，验证者必须在不同时间内至少看到某些消息。以下是我们所获知的这4个验证者的视图（view）：

![img](.\img\fig6_A_view.png) 

A的视图

![img](.\img\fig7_C_view.png) 

C的视图

![img](.\img\fig8_D_view.png) 

D的视图

![img](.\img\fig9_E_view.png) 

E的视图

绿色表示每个验证者生成的区块，蓝色表示我们所知道的他们从其他验证者处看到的最新的消息。

需要注意的是，这4个验证者都可以看到B的其中一个甚至两个区块，而D和E可以看到C的第二个区块，因此他们把这而不是C的第一个区块作为视图的最新消息。然而，我们无法通过链的结构本身来证明他们确实是这么做的。所幸的是，正如我们将在下面看到的，这种模糊状况对于我们来说无关紧要。

A的视图包含支持底链的4条最新消息，而没有支持B的区块的消息。因此，在（我们模拟的）A眼中，支持底链的权重至少为4:1。C，D和E的视图描绘了类似的情形，即均有4条支持底链的最新消息。因此，这4个验证者都无法轻易改变主意，除非另外2个验证者首先改变他们的想法，将得分改为2：3，从而支持B的区块。

请注意，我们对验证者的视图的模拟是“过时的”。例如，他并不知情D和E已经看到C最新的区块。然而，这并不会改变顶链和底链对决的计算结果。因为我们可以非常普遍地认为，任何验证者的新消息都会与其之前的消息具有相同的意见，除非另外两个验证者已经先切换了队列。

![img](.\img\fig10_minimal_attack.png) 

最小可行攻击。A和C非法切换队列，改为支持B的区块（并且可能因此受到惩罚）。这一行为最终导致顶链和底链3：2的结果，这时D和E就可以合法切换队列了。

由于诸如LMD GHOST之类的分叉选择规则在这一方面的粘性很大，并且客户端可以检测到分叉选择规则何时“黏在”特定的区块上，因此我们可以使用这种方法作为实现异步安全共识的方式。

 

 